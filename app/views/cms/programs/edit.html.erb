<h1><%= t('programs.edit.title') %></h1>

<div class="form-container">
  <%= form_with model: [:cms, @program], local: true do |f| %>
    <% if @program.errors.any? %>
      <div class="alert alert-error">
        <h4><%= pluralize(@program.errors.count, t("programs.edit.error_count")) %> <%= t('programs.edit.errors_prevented_save') %></h4>
        <ul>
          <% @program.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :title, t('programs.edit.program_title') %>
      <%= f.text_field :title, class: "form-control", required: true %>
    </div>

    <div class="form-group">
      <%= f.label :description, t('programs.edit.description') %>
      <%= f.text_area :description, class: "form-control", rows: 4 %>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= f.label :kind, t('programs.edit.content_type') %>
        <%= f.select :kind, options_for_select([
          [t('program_types.podcast'), 'podcast'], 
          [t('program_types.documentary'), 'documentary']
        ], @program.kind), {}, { class: "form-control", required: true } %>
      </div>

      <div class="form-group">
        <%= f.label :language, t('programs.edit.language') %>
        <%= f.select :language, options_for_select([
          [t('languages.en'), 'en'], 
          [t('languages.ar'), 'ar']
        ], @program.language), {}, { class: "form-control", required: true } %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= f.label :category, t('programs.edit.category') %>
        <%= f.select :category, options_for_select([
          ['', ''],
          [t('categories.technology'), 'Technology'], 
          [t('categories.education'), 'Education'],
          [t('categories.entertainment'), 'Entertainment'],
          [t('categories.news'), 'News'],
          [t('categories.sports'), 'Sports'],
          [t('categories.health'), 'Health'],
          [t('categories.business'), 'Business'],
          [t('categories.arts'), 'Arts']
        ], @program.category), {}, { class: "form-control" } %>
      </div>

      <div class="form-group">
        <%= f.label :published_at, t('programs.edit.publish_date') %>
        <%= f.datetime_local_field :published_at, class: "form-control", value: @program.published_at&.strftime("%Y-%m-%dT%H:%M") %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :tags, t('programs.edit.tags_hint') %>
      <%= f.text_field :tags, value: @program.tags&.join(', '), class: "form-control", placeholder: t('programs.edit.tags_placeholder') %>
    </div>

    <!-- File Upload Section -->
    <div class="file-section">
      <h3><%= t('programs.edit.media_file') %></h3>
      
      <% if @program.source_s3_key.present? %>
        <div class="current-file-info">
          <div class="file-status">
            <div class="status-indicator status-<%= @program.status %>">
              <span class="status-dot"></span>
              <%= t("status.#{@program.status}") %>
            </div>
            
            <div class="file-metadata">
              <p><strong><%= t('programs.edit.current_file') %>:</strong></p>
              <p class="file-name"><%= File.basename(@program.source_s3_key) %></p>
              
              <% if @program.duration_seconds %>
                <p><strong><%= t('programs.edit.duration') %>:</strong> <%= time_duration_in_words(@program.duration_seconds) %></p>
              <% end %>
              
              <% if @program.stream_path.present? %>
                <p><strong><%= t('programs.edit.stream_url') %>:</strong> 
                  <a href="https://<%= ENV['CLOUDFRONT_DOMAIN'] %><%= @program.stream_path %>" target="_blank" class="stream-link">
                    <%= t('programs.edit.view_stream') %>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M7 17L17 7" stroke="currentColor" stroke-width="2"/>
                      <path d="M7 7h10v10" stroke="currentColor" stroke-width="2"/>
                    </svg>
                  </a>
                </p>
              <% end %>
            </div>
          </div>
          
          <% if @program.status == 'failed' %>
            <div class="retry-section">
              <p class="retry-message"><%= t('programs.edit.upload_failed_message') %></p>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="no-file-info">
          <p><%= t('programs.edit.no_file_uploaded') %></p>
        </div>
      <% end %>
      
      <div class="file-upload-section">
        <h4><%= @program.source_s3_key.present? ? t('programs.edit.replace_file') : t('programs.edit.upload_file') %></h4>
        <p class="upload-hint"><%= t('programs.edit.upload_hint') %></p>
        
        <div class="upload-area" id="upload-area">
          <input type="file" id="file-input" accept="video/*,audio/*" style="display: none;">
          <div class="upload-content">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
              <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2"/>
              <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
            </svg>
            <p><%= t('programs.edit.upload_area_text') %></p>
            <button type="button" class="btn-choose-file" onclick="document.getElementById('file-input').click()">
              <%= t('programs.edit.choose_file') %>
            </button>
          </div>
          
          <div class="upload-progress" id="upload-progress" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="progress-text" id="progress-text">0%</p>
          </div>
        </div>
        
        <div class="selected-file-info" id="selected-file-info" style="display: none;">
          <p><strong><%= t('programs.edit.selected_file') %>:</strong> <span id="selected-file-name"></span></p>
          <p><strong><%= t('programs.edit.file_size') %>:</strong> <span id="selected-file-size"></span></p>
          <button type="button" class="btn-upload" id="upload-btn" onclick="startUpload()">
            <%= t('programs.edit.start_upload') %>
          </button>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <%= f.submit t('programs.edit.update_program'), class: "btn" %>
      <%= link_to t('common.cancel'), cms_program_path(@program), class: "btn btn-secondary" %>
    </div>
  <% end %>
</div>

<style>
  .form-container {
    max-width: 800px;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    direction: <%= I18n.locale == :ar ? 'rtl' : 'ltr' %>;
    text-align: <%= I18n.locale == :ar ? 'right' : 'left' %>;
  }
  
  .form-container h1 {
    color: #212529;
    font-weight: 700;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #495057;
    font-size: 0.95rem;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #DEE2E6;
    border-radius: 8px;
    background: #FFFFFF;
    color: #495057;
    font-size: 1rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  
  .form-control:focus {
    outline: none;
    border-color: #00D35B;
    box-shadow: 0 0 0 3px rgba(0, 211, 91, 0.1);
  }
  
  select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: <%= I18n.locale == :ar ? 'left 0.75rem center' : 'right 0.75rem center' %>;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    <%= I18n.locale == :ar ? 'padding-left: 2.5rem;' : 'padding-right: 2.5rem;' %>
  }
  
  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #E9ECEF;
    justify-content: <%= I18n.locale == :ar ? 'flex-start' : 'flex-end' %>;
  }
  
  .btn {
    background: #00D35B;
    color: #000000;
    padding: 0.875rem 2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
    font-size: 0.95rem;
  }
  
  .btn:hover {
    background: #00B94E;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 211, 91, 0.3);
  }
  
  .btn-secondary {
    background: transparent;
    color: #6C757D;
    border: 1px solid #DEE2E6;
  }
  
  .btn-secondary:hover {
    background: #F8F9FA;
    color: #495057;
    border-color: #ADB5BD;
    transform: translateY(-2px);
  }
  
  .alert {
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    border: 1px solid transparent;
  }
  
  .alert-error {
    background: rgba(220, 53, 69, 0.1);
    color: #721c24;
    border-color: rgba(220, 53, 69, 0.3);
  }
  
  .alert h4 {
    margin-bottom: 0.75rem;
    font-size: 1rem;
    font-weight: 600;
  }
  
  .alert ul {
    margin: 0;
    padding-<%= I18n.locale == :ar ? 'right' : 'left' %>: 1.5rem;
  }
  
  .alert li {
    margin-bottom: 0.25rem;
  }
  
  textarea.form-control {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  
  /* File Upload Section Styles */
  .file-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #F8F9FA;
    border-radius: 12px;
    border: 1px solid #E9ECEF;
  }
  
  .file-section h3 {
    color: #212529;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #00D35B;
    padding-bottom: 0.5rem;
  }
  
  .current-file-info {
    background: #FFFFFF;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #DEE2E6;
  }
  
  .file-status {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    white-space: nowrap;
  }
  
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  
  .status-ready { 
    background: rgba(0, 211, 91, 0.1); 
    color: #00D35B; 
    border: 1px solid rgba(0, 211, 91, 0.3);
  }
  .status-ready .status-dot { background: #00D35B; }
  
  .status-processing { 
    background: rgba(255, 193, 7, 0.1); 
    color: #FFC107; 
    border: 1px solid rgba(255, 193, 7, 0.3);
  }
  .status-processing .status-dot { 
    background: #FFC107; 
    animation: pulse 2s infinite;
  }
  
  .status-failed { 
    background: rgba(220, 53, 69, 0.1); 
    color: #DC3545; 
    border: 1px solid rgba(220, 53, 69, 0.3);
  }
  .status-failed .status-dot { background: #DC3545; }
  
  .status-draft { 
    background: rgba(108, 117, 125, 0.1); 
    color: #6C757D; 
    border: 1px solid rgba(108, 117, 125, 0.3);
  }
  .status-draft .status-dot { background: #6C757D; }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .file-metadata {
    flex: 1;
    text-align: <%= I18n.locale == :ar ? 'right' : 'left' %>;
  }
  
  .file-name {
    font-family: monospace;
    background: #F8F9FA;
    padding: 0.5rem;
    border-radius: 4px;
    color: #495057;
    word-break: break-all;
    font-size: 0.875rem;
  }
  
  .stream-link {
    color: #00D35B;
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: color 0.2s ease;
  }
  
  .stream-link:hover {
    color: #00B94E;
  }
  
  .retry-section {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    border-radius: 8px;
  }
  
  .retry-message {
    color: #721c24;
    margin: 0;
    font-weight: 500;
  }
  
  .no-file-info {
    background: #FFFFFF;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 2px dashed #DEE2E6;
    text-align: center;
    color: #6C757D;
  }
  
  .file-upload-section h4 {
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .upload-hint {
    color: #6C757D;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    line-height: 1.5;
  }
  
  .upload-area {
    background: #FFFFFF;
    border: 2px dashed #DEE2E6;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .upload-area:hover {
    border-color: #00D35B;
    background: rgba(0, 211, 91, 0.05);
  }
  
  .upload-area.dragover {
    border-color: #00D35B;
    background: rgba(0, 211, 91, 0.1);
  }
  
  .upload-content svg {
    color: #ADB5BD;
    margin-bottom: 1rem;
  }
  
  .upload-content p {
    color: #6C757D;
    margin-bottom: 1rem;
    font-size: 1rem;
  }
  
  .btn-choose-file {
    background: #00D35B;
    color: #000000;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }
  
  .btn-choose-file:hover {
    background: #00B94E;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 211, 91, 0.3);
  }
  
  .upload-progress {
    margin-top: 1rem;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #E9ECEF;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00D35B 0%, #00B94E 100%);
    transition: width 0.3s ease;
    width: 0%;
  }
  
  .progress-text {
    color: #6C757D;
    font-size: 0.875rem;
    margin: 0;
    text-align: center;
  }
  
  .selected-file-info {
    background: #FFFFFF;
    border: 1px solid #00D35B;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .selected-file-info p {
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }
  
  .btn-upload {
    background: #00D35B;
    color: #000000;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 1rem;
    font-size: 0.9rem;
  }
  
  .btn-upload:hover {
    background: #00B94E;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 211, 91, 0.3);
  }
  
  .btn-upload:disabled {
    background: #ADB5BD;
    color: #6C757D;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  @media (max-width: 768px) {
    .form-container {
      padding: 1.5rem;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .form-actions {
      flex-direction: column;
    }
    
    .file-status {
      flex-direction: column;
      gap: 1rem;
    }
    
    .file-section {
      padding: 1rem;
    }
    
    .upload-area {
      padding: 1.5rem 1rem;
    }
  }
</style>

<script>
  let selectedFile = null;
  const programId = <%= @program.id %>;
  
  // Convert comma-separated tags to array on form submit
  document.querySelector('form').addEventListener('submit', function(e) {
    const tagsInput = document.querySelector('input[name="program[tags]"]');
    if (tagsInput.value) {
      const tagsArray = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
      
      // Create hidden inputs for each tag
      tagsArray.forEach(tag => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'program[tags][]';
        hiddenInput.value = tag;
        this.appendChild(hiddenInput);
      });
      
      // Clear the original input to avoid duplication
      tagsInput.name = '';
    }
  });
  
  // File upload functionality
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const selectedFileInfo = document.getElementById('selected-file-info');
    
    // File input change handler
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        showSelectedFile(file);
      }
    });
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('video/') || file.type.startsWith('audio/')) {
          selectedFile = file;
          showSelectedFile(file);
        } else {
          alert('<%= t("programs.edit.invalid_file_type") || "Please select a video or audio file" %>');
        }
      }
    });
    
    // Click to select file
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
  });
  
  function showSelectedFile(file) {
    const selectedFileInfo = document.getElementById('selected-file-info');
    const selectedFileName = document.getElementById('selected-file-name');
    const selectedFileSize = document.getElementById('selected-file-size');
    
    selectedFileName.textContent = file.name;
    selectedFileSize.textContent = formatFileSize(file.size);
    selectedFileInfo.style.display = 'block';
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  async function startUpload() {
    if (!selectedFile) return;
    
    const uploadBtn = document.getElementById('upload-btn');
    const progressContainer = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    uploadBtn.disabled = true;
    uploadBtn.textContent = '<%= t("programs.edit.uploading") || "Uploading..." %>';
    progressContainer.style.display = 'block';
    
    try {
      // Check if function is available
      if (typeof performUnifiedUpload === 'undefined') {
        throw new Error('Upload function not available');
      }
      
      // Use the unified upload system from application.js
      const result = await performUnifiedUpload(selectedFile, {
        progressElement: progressFill,
        progressTextElement: progressText,
        onProgress: (progress) => {
          // Additional progress handling if needed
        },
        onComplete: (result) => {},
        onError: (error) => {}
      });
      
      // Mark ingest complete (this will replace the old file)
      const ingestResponse = await fetch(`/api/cms/programs/${programId}/ingest_complete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          s3_key: result.key
        })
      });
      
      if (!ingestResponse.ok) {
        const errorData = await ingestResponse.json();
        throw new Error(`Failed to mark ingest complete: ${errorData.error || ingestResponse.statusText}`);
      }
      
      // Success! Reload the page to show the updated status
      alert('<%= t("programs.edit.upload_success") || "File uploaded successfully! Processing will begin shortly." %>');
      location.reload();
      
    } catch (error) {
      alert('<%= t("programs.edit.upload_error") || "Upload failed" %>: ' + error.message);
      
      // Reset UI
      uploadBtn.disabled = false;
      uploadBtn.textContent = '<%= t("programs.edit.start_upload") %>';
      progressContainer.style.display = 'none';
    }
  }
</script>
